<!--
  Same as before, but detect mouseover on window.

  Incidentally, now child windows can have their own child windows
-->
<html>
<body>

<script>
  // Save the html as it exists when the page is first rendered
  const html = document.body.outerHTML

  if (window.opener) {
    // *** RUNS IN CHILD WINDOW: ***

    // Store timer in a variable so it can be canceled
    let timeout = null

    document.addEventListener('mousemove', () => {
      // Cancel previous timer
      clearTimeout(timeout)

      // Set background color to green
      document.body.style.backgroundColor = 'green'

      // If no more mousemoves in 500ms, then reset background color
      timeout = setTimeout(() => {
        document.body.style.backgroundColor = ''
      }, 500)
    })

    // Better detection of closed windows. Child tells parent when it has closed
    window.onunload = () => {
      if (!window.opener.closed) window.opener.onCloseWindow(window)
    }
  }

  // *** RUNS IN PARENT AND CHILD WINDOWS: ***

  let wins = []

  document.addEventListener('click', openWindow)

  function openWindow () {
    focusWindows()
    const win = window.open('', '', 'width=100,height=100,left=0,top=0')

    // Write HTML into the child window
    win.document.write(`<html>${html}</html>`)

    wins.push(win)
  }

  function focusWindows () {
    wins.forEach(win => win.focus())
  }

  // Called by child to notify parent when it has closed
  function onCloseWindow (win) {
    const i = wins.indexOf(win)
    if (i >= 0) wins.splice(i, 1)
  }

  let i = 0
  setInterval(() => {
    if (wins.length === 0) return

    wins.forEach((win, j) => {
      win.moveTo(i + (j * 100), i + (j * 100))
    })
    i += 5
    i = i % 200
  }, 100)

</script>

</body>
</html>
