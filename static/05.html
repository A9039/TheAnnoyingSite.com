<!--
  Same as before, but add "decentralized" windows (windows that move themselves)
-->
<html>
<body>

<script>
  if (window.opener) {
    // *** RUNS IN CHILD WINDOW: ***

    // Each window animates itself, instead of being controlled by the parent window.
    // The window continues to move even if it's parent is closed. Decentralization!
    let i = 0
    setInterval(() => {
      window.moveTo(i, i)
      i += 5
      i = i % 200
    }, 100)

    let timeout = null
    document.addEventListener('mousemove', () => {
      clearTimeout(timeout)
      document.body.style.backgroundColor = 'green'
      timeout = setTimeout(() => {
        document.body.style.backgroundColor = ''
      }, 500)
    })

    window.onunload = () => {
      if (!window.opener.closed) window.opener.onCloseWindow(window)
    }
  }

  // *** RUNS IN PARENT AND CHILD WINDOWS: ***

  let wins = []

  document.addEventListener('click', openWindow)

  function openWindow () {
    focusWindows()
    const win = window.open(window.location.pathname, '', 'width=100,height=100,left=0,top=0')
    wins.push(win)
  }

  function focusWindows () {
    wins.forEach(win => win.focus())
  }

  function onCloseWindow (win) {
    const i = wins.indexOf(win)
    if (i >= 0) wins.splice(i, 1)
  }

</script>

</body>
</html>
