<!--
  Same as before, but bounce off the screen edges
-->
<html>
<body>

<style>
  body { html, body { width: 100% } }
</style>

<script>
  const SCREEN_WIDTH = window.screen.availWidth
  const SCREEN_HEIGHT = window.screen.availHeight
  const WINDOW_WIDTH = 200
  const WINDOW_HEIGHT = 200
  const VELOCITY = 15
  const MARGIN = 10
  const TICK_LENGTH = 50

  if (window.opener) {
    // *** RUNS IN CHILD WINDOW: ***

    let vx = VELOCITY * (Math.random() > 0.5 ? 1 : -1)
    let vy = VELOCITY * (Math.random() > 0.5 ? 1 : -1)

    window.setInterval(() => {
      const x = window.screenX
      const y = window.screenY
      const width = window.outerWidth
      const height = window.outerHeight

      if (x < MARGIN) vx = Math.abs(vx)
      if (x + width > SCREEN_WIDTH - MARGIN) vx = -1 * Math.abs(vx)
      if (y < MARGIN) vy = Math.abs(vy)
      if (y + height > SCREEN_HEIGHT - MARGIN) vy = -1 * Math.abs(vy)

      window.moveBy(vx, vy)
    }, TICK_LENGTH)

    let timeout = null
    document.addEventListener('mousemove', () => {
      clearTimeout(timeout)
      document.body.style.backgroundColor = 'green'
      timeout = setTimeout(() => {
        document.body.style.backgroundColor = ''
      }, 500)
    })

    window.onunload = () => {
      if (!window.opener.closed) window.opener.onCloseWindow(window)
    }
  }

  // *** RUNS IN PARENT AND CHILD WINDOWS: ***

  let wins = []

  document.addEventListener('click', openWindow)

  function openWindow () {
    focusWindows()

    const x = MARGIN + Math.floor(Math.random() * (SCREEN_WIDTH - WINDOW_WIDTH - MARGIN))
    const y = MARGIN + Math.floor(Math.random() * (SCREEN_HEIGHT - WINDOW_HEIGHT - MARGIN))

    const win = window.open('', '', `width=${WINDOW_WIDTH},height=${WINDOW_HEIGHT},left=${x},top=${y},location,titlebar`)
    win.document.write(`<html>${document.body.outerHTML}</html>`)
    wins.push(win)
  }

  function focusWindows () {
    wins.forEach(win => win.focus())
  }

  function onCloseWindow (win) {
    const i = wins.indexOf(win)
    if (i >= 0) wins.splice(i, 1)
  }

</script>

</body>
</html>
